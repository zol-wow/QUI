name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create addon zip
        run: |
          mkdir -p build/QUI

          rsync -av --progress . build/QUI/ \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='build' \

          # re-add specific md files we want in the release
          cp README.md build/QUI/ 2>/dev/null || true
          cp CHANGELOG.md build/QUI/ 2>/dev/null || true
          cp LICENSE build/QUI/ 2>/dev/null || true

          # create the zip from inside build/ so the path is QUI/...
          cd build
          zip -r ../QUI-${{ steps.version.outputs.version }}.zip QUI

      - name: Extract changelog for release
        id: changelog
        run: |
          # Extract the section for this version from CHANGELOG.md
          # Looks for ## [vX.Y.Z] or ## vX.Y.Z and captures until next ## or EOF
          VERSION="${{ steps.version.outputs.version }}"

          if [ -f CHANGELOG.md ]; then
            NOTES=$(awk -v ver="$VERSION" '
              /^## / {
                if (found) exit
                if ($0 ~ ver) { found=1; next }
              }
              found { print }
            ' CHANGELOG.md)

            if [ -z "$NOTES" ]; then
              NOTES="Release $VERSION"
            fi
          else
            NOTES="Release $VERSION"
          fi

          echo "$NOTES" > release_notes.txt

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: QUI-${{ steps.version.outputs.version }}.zip
          body_path: release_notes.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to CurseForge
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          CHANGELOG=$(cat release_notes.txt)
          METADATA=$(jq -n \
            --arg changelog "$CHANGELOG" \
            --arg name "QUI-${{ steps.version.outputs.version }}" \
            '{
              changelog: $changelog,
              changelogType: "markdown",
              displayName: $name,
              gameVersions: [13924,14422],
              releaseType: "release"
            }')
          
          curl --fail-with-body -X POST \
            "https://wow.curseforge.com/api/projects/${{ secrets.CF_PROJECT_ID }}/upload-file" \
            -H "X-Api-Token: ${CF_API_TOKEN}" \
            -F "metadata=${METADATA}" \
            -F "file=@QUI-${{ steps.version.outputs.version }}.zip"

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ steps.version.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          # Read the extracted changelog
          CHANGELOG=$(cat release_notes.txt)
          
          # Construct URLs
          RELEASE_URL="https://github.com/$REPO/releases/tag/$VERSION"
          ZIP_URL="https://github.com/$REPO/releases/download/$VERSION/QUI-$VERSION.zip"
          
          # Truncate changelog if it exceeds Discord's 4096 character embed limit
          if [ ${#CHANGELOG} -gt 4000 ]; then
            CHANGELOG="${CHANGELOG:0:4000}... *(Changelog truncated, view GitHub release for full notes)*"
          fi

          # Use jq to safely format the multi-line text into valid JSON
          JSON_PAYLOAD=$(jq -n \
            --arg version "$VERSION" \
            --arg url "$RELEASE_URL" \
            --arg zip "$ZIP_URL" \
            --arg changelog "$CHANGELOG" \
            '{
              content: "ðŸš€ **New QUI Release:** \($version)\n\nðŸ“¥ **[Download \($version) zip](\($zip))**\nðŸ”— [View Release on GitHub](\($url))\n\nðŸ’– *A massive thank you to everyone using the addon, raising issues, requesting new features, testing tirelessly, contributing merge requests, and supporting development via Ko-Fi or PayPal!*\n\n",
              embeds: [
                {
                  title: "Changelog",
                  description: $changelog,
                  color: 3447003
                }
              ]
            }')
          
          # Send the request to Discord
          curl -H "Content-Type: application/json" -d "$JSON_PAYLOAD" $DISCORD_WEBHOOK
